# ブロックチェーン
## ブロックチェーンの存在理由
- ビットコインのブロックチェーンに格納されている内容は世界中で発生したトランザクション
    - それだけならP2Pで全サーバーのDBに格納し続けるだけで良い

#### ブロックが必要だった理由は、ブロックを対象とする処理を調べてみればわかる
- 不正を含まない台帳記録としてコンセンサスを確定する処理
- プルーフ・オブ・ワークの付与によって記録の非可逆性を保証する処理
- 分岐(フォーク)が可能な時系列的記録の中で、ベストなものをマイニングゲームによって選択する処理

### コンセンサス処理の最適化方法としてのブロック
ブロックサイズの最適値は以下の要素の複雑な関係を持つ
- ブロックを生成する時間感覚
- トランザクションの発生頻度
- P2Pネットワークに参加するノード数
- ネットワークのレイテンシやスループット

### コンセンサスの表現(representation)としてのブロック
- ビットコインのコンセンサスは創発的コンセンサスと呼ばれる

### ブロックチェーーのソフトフォークとハードフォーク
- 全世界の全てのビットコイン利用者やマイナーのプログラムコードを一斉にバージョンアップすることは現実的に不可能
- ソフトフォークは古いブロックの仕様と互換性のある仕様の修正
- ハードフォークは古いバージョンのノードから見れば不正なブロックんい見えてしまう大きな仕様の変更

## ブロックの構造
|サイズ|フィールド名|説明|
|4バイト|Block Size|ブロックのデータサイズ(バイト)|
|80バイト|Block Header|ブロックヘッダ|
|1~9バイト|Transaction Counter|ブロックに含まれるトランザクション数|
|可変長|Transactions|ブロックに含まれるトランザクションのリスト|

### ブロックの識別子
ブロックを参照するためのブロックの識別子には
- ブロックハッシュ
- ブロック高

bitcoin-cliのgetchaintipsコマンドを使うと、現在のブロックチェーンの先端がわかる

### ブロックヘッダの構造
- ブロックに含まれるトランザクションはマークル木を使ったハッシュチェーンとしてまとめ上げられる
- その構造の根にあたるマークルルートがブロックヘッダのMerkle root hashフィールドに埋め込まれて居る

### マークル木
ブロックヘッダにそのブロックに含まれる全トランザクションをまとめあげたマークルルートが埋め込まれていることでそこに含まれる任意のトランザクションが実際にブロックに含まれて居ることを効率的に証明できる

- ビットコインのノードの中にはブロックチェーンの全データではなく、ヘッダ情報だけを持つノードもある
    - SPV(Simple Payment Verification)ノードと呼ぶ
    - スマホのウォレットのほとんどはSPVノード

### ブロックサイズ
- 処理効率の最適化の観点だけから見ると理論的に最適なブロックサイズが定まる
    - 2018年3月現在で1ブロックサイズの上限が1メガバイト
    - 明らかにブロックサイズが足りていないが、理論的な最適値が求められていない
- 常時稼働してるフルノード数は約7000

## マイニング
- プルーフオブワーク法を用いている
    - 1997年に発明されたHashcashアルゴリズムを利用
- 暗号学的ハッシュ関数をnonceをシードとする擬似乱数生成装置とみなし、そのハッシュ値がある難易度ターゲットよりも小さい数値となるようなnonceを求める計算

### ビットコインの通貨単位
- マイナーが通貨発行者と思われがちだが違う
    - バランスシートの視点で見れば、無から一定の貨幣的価値が生じたような状況が存在している

### マイニング処理
- Nonceフィールドの値を順次変更しながらブロックヘッダのSHA-256によるハッシュ値の計算を求める
    - そのハッシュ値がブロックヘッダのDifficulty Targetフィールドで定められた難易度ターゲットよりも小さい数値であれば成功

#### プルーフオブワークの実際の値
- Nonceフィールドは4byte = 43億通りしかない
- 現在はextraNonce = コインベースのインプット領域 を8バイト追加して12バイトあることにして対応している 







































